<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>R.A.L.F. – Music Showcase</title>
  <meta name="description" content="R.A.L.F. – Musik mit Kategorien, Cover-Galerie und integriertem Player." />
  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <meta property="og:title" content="R.A.L.F. – Music Showcase" />
  <meta property="og:description" content="Stream deine Songs direkt auf deiner Seite, ohne Suno-Login." />
  <meta property="og:image" content="assets/logo-512.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    img, audio, video { -webkit-user-drag: none; user-select: none; }
  </style>
</head>

<body class="min-h-screen bg-neutral-950 text-neutral-100">
  <!-- Banner mit Logo (du wolltest die 'fill'-Variante) -->
  <header class="relative w-full h-[180px] bg-black">
    <img src="/assets/logo-banner.png" alt="R.A.L.F. Banner"
         class="absolute inset-0 w-full h-full object-fill" />
  </header>

  <!-- Text unter dem Banner -->
  <div class="max-w-7xl mx-auto px-4 mt-4 flex items-center justify-between">
    <div>
      <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">R.A.L.F. – Music Showcase</h1>
      <p class="text-neutral-400 text-sm">Musik von mir, für Euch.</p>
    </div>
    <!-- Suchfeld -->
    <div class="shrink-0 w-64 sm:w-80">
      <input id="search" type="text" placeholder="Suche Songs oder Künstler ⌘K"
             class="w-full rounded-2xl bg-neutral-800/80 ring-1 ring-white/10 px-4 py-2 text-sm text-white placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-white/30">
    </div>
  </div>

  <!-- Kategorien-Leiste -->
  <div id="catBar" class="max-w-7xl mx-auto px-4 mt-4 flex flex-wrap gap-2"></div>

  <section id="catGallery" class="max-w-6xl mx-auto px-4 py-10 hidden">
    <h2 class="text-lg font-bold mb-4">Kategorien</h2>
    <div id="catGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6 mb-10"></div>
  </section>

  <main class="max-w-6xl mx-auto px-4 pb-24">
    <div id="songsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
    <p id="emptyState" class="text-neutral-400 hidden">Keine Treffer. Suchbegriff anpassen.</p>
  </main>

  <!-- Player-Dock -->
  <div id="playerDock" class="fixed left-0 right-0 bottom-0 bg-neutral-900/95 backdrop-blur border-t border-neutral-800 hidden">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-4">
      <img id="playerCover" class="w-12 h-12 rounded-lg object-cover" />
      <div class="flex-1 min-w-0">
        <div id="playerTitle" class="text-sm font-semibold truncate"></div>
        <div id="playerArtist" class="text-xs text-neutral-400 truncate"></div>
        <div id="playerBar" class="mt-2 h-1.5 bg-neutral-700 rounded-full overflow-hidden cursor-pointer">
          <div id="playerProgress" class="h-full bg-orange-500" style="width:0%"></div>
        </div>
      </div>
      <audio id="audio" controls class="w-64" preload="metadata"></audio>
      <button id="closeBtn" class="px-3 py-1.5 text-sm rounded-lg border border-neutral-700 hover:border-neutral-500">Schließen</button>
    </div>
  </div>

  <footer class="border-t border-neutral-800">
    <div class="max-w-6xl mx-auto px-4 py-8 text-xs text-neutral-500">
      © R.A.L.F. – Alle Rechte vorbehalten. Streaming-only. Downloads deaktiviert.
    </div>
  </footer>

  <!-- App-Script -->
  <script>
    const state = { songs: [], categories: [], cat: 'all', query: '', active: null };

    // Editor-Hook: Live neu rendern
    window.renderSite = function(songs, categories){
      if (songs) state.songs = Array.isArray(songs) ? songs : (songs.songs || []);
      if (categories) state.categories = Array.isArray(categories) ? categories : (categories.categories || []);
      render();
    };

    async function loadData() {
      // lokale Editor-Overrides
      const localSongs = localStorage.getItem('ralf_songs_json');
      const localCats  = localStorage.getItem('ralf_categories_json');
      if (localSongs) {
        try { const s = JSON.parse(localSongs); state.songs = Array.isArray(s) ? s : (s.songs || []); } catch(e){}
      }
      if (localCats) {
        try { const c = JSON.parse(localCats); state.categories = Array.isArray(c) ? c : (c.categories || []); } catch(e){}
      }

      // Fallback: vom Server
      if (!state.songs.length || !state.categories.length) {
        const s = await fetch('songs.json').then(r=>r.json());
        const c = await fetch('categories.json').then(r=>r.json());
        state.songs = Array.isArray(s) ? s : (s.songs || []);
        state.categories = Array.isArray(c) ? c : (c.categories || []);
      }

      // UI bauen
      renderCatBar();
      applyQueryFromURL();
      render();

      // Deep-Link (nach dem Laden)
      const pid = new URLSearchParams(location.search).get('id');
      if (pid) {
        const song = state.songs.find(x => x.id === pid);
        if (song) setTimeout(() => playSong(song), 100);
      }
    }

    function applyQueryFromURL() {
      const p = new URLSearchParams(location.search);
      state.cat = p.get('cat') || 'all';
      state.query = (p.get('q') || '').toLowerCase();
      const search = document.getElementById('search');
      if (search) search.value = state.query;
    }

    function setCat(cat) {
      state.cat = cat;
      const p = new URLSearchParams(location.search);
      p.set('cat', cat);
      history.replaceState(null, '', '?' + p.toString());
      render();
    }

    function setQuery(q) {
      state.query = (q || '').toLowerCase();

      // Bei aktiver Suche immer global suchen
      if (state.query) state.cat = 'all';

      const p = new URLSearchParams(location.search);
      if (state.query) {
        p.set('q', q);
        p.set('cat', 'all');
      } else {
        p.delete('q');
      }
      history.replaceState(null, '', '?' + p.toString());
      render();
    }

    function renderCatBar() {
      const bar = document.getElementById('catBar');
      bar.innerHTML = '';

      // „Alle“-Button
      const allBtn = document.createElement('button');
      allBtn.textContent = 'Alle';
      allBtn.className = 'px-3 py-1.5 rounded-full border text-sm transition ' +
        (state.cat === 'all'
          ? 'bg-orange-600 border-orange-500 text-white'
          : 'bg-neutral-900 border-neutral-700 text-neutral-300 hover:border-neutral-500');
      allBtn.onclick = () => setCat('all');
      bar.appendChild(allBtn);

      // Kategorien
      state.categories.forEach(c => {
        const b = document.createElement('button');
        b.textContent = c.label;
        b.className = 'px-3 py-1.5 rounded-full border text-sm transition ' +
          (state.cat === c.key
            ? 'bg-orange-600 border-orange-500 text-white'
            : 'bg-neutral-900 border-neutral-700 text-neutral-300 hover:border-neutral-500');
        b.onclick = () => setCat(c.key);
        bar.appendChild(b);
      });
    }

    function renderCategoryGallery() {
      const showGallery = state.cat === 'all' && !state.query;
      const section = document.getElementById('catGallery');
      section.classList.toggle('hidden', !showGallery);
      if (!showGallery) return;

      const grid = document.getElementById('catGrid');
      grid.innerHTML = '';
      state.categories.forEach(c => {
        const card = document.createElement('div');
        card.className = 'group relative cursor-pointer rounded-2xl overflow-hidden border border-neutral-800 hover:border-neutral-600';
        card.onclick = () => setCat(c.key);
        card.innerHTML = `
          <img src="${c.cover}" alt="${c.label}" class="w-full h-32 object-contain bg-black" />
          <div class="absolute inset-0 bg-black/50 flex items-center justify-center">
            <span class="font-semibold text-white text-sm sm:text-base">${c.label}</span>
          </div>`;
        grid.appendChild(card);
      });
    }

    // WICHTIG: Suche hat Vorrang. Wenn Suche aktiv ist, wird Kategorie ignoriert.
    function renderSongs() {
      const q = (state.query || '').trim().toLowerCase();
      const grid = document.getElementById('songsGrid');
      const empty = document.getElementById('emptyState');
      if (!grid) return;

      grid.innerHTML = '';

      let list = Array.isArray(state.songs) ? state.songs.slice() : [];

      if (q) {
        list = list.filter(s =>
          (s.title  || '').toLowerCase().includes(q) ||
          (s.artist || '').toLowerCase().includes(q)
        );
      } else if (state.cat && state.cat !== 'all') {
        list = list.filter(s => s.category === state.cat);
      }

      if (list.length === 0) {
        if (empty) empty.classList.remove('hidden');
        return;
      } else {
        if (empty) empty.classList.add('hidden');
      }

      list.forEach(s => {
        const card = document.createElement('div');
        card.className = 'group bg-neutral-900/70 border border-neutral-800 rounded-2xl overflow-hidden hover:border-neutral-600 transition';
        card.innerHTML = `
  <div class="aspect-square overflow-hidden relative">
    <img src="${s.cover}" alt="${s.title}" class="w-full h-full object-cover group-hover:scale-105 transition" />
  </div>
  <div class="p-4">
    <div class="text-xs text-neutral-400 mb-1">${s.category}</div>
    <h3 class="font-semibold leading-tight">${s.title}</h3>
    <div class="text-sm text-neutral-400">${s.artist}</div>
    <div class="mt-3 flex justify-end">
      <button class="play bg-white/90 text-black text-sm font-semibold rounded-full px-3 py-1.5 shadow hover:bg-white">
        ▶ Abspielen
      </button>
    </div>
  </div>`;
        card.querySelector('.play').onclick = () => playSong(s);
        grid.appendChild(card);
      });
    }

    function playSong(s) {
      state.active = s.id;
      document.getElementById('playerDock').classList.remove('hidden');
      document.getElementById('playerCover').src = s.cover;
      document.getElementById('playerTitle').textContent = s.title;
      document.getElementById('playerArtist').textContent = s.artist;
      const audio = document.getElementById('audio');
      audio.src = s.src;
      audio.play().catch(() => {});
      audio.ontimeupdate = () => {
        const pct = Math.min(100, Math.round((audio.currentTime / (s.duration || 1)) * 100));
        document.getElementById('playerProgress').style.width = pct + '%';
      };
    }

    function render() {
      renderCatBar();
      renderCategoryGallery();
      renderSongs();
    }

    // Dock schließen
    document.getElementById('closeBtn').onclick = () => {
      document.getElementById('playerDock').classList.add('hidden');
      document.getElementById('audio').pause();
    };

    // Suche verdrahten
    document.getElementById('search').addEventListener('input', (e) => setQuery(e.target.value));
    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
        e.preventDefault(); const i = document.getElementById('search'); i.focus(); i.select();
      }
    });

    // Los geht's
    loadData();
  </script>

  <!-- Extra Script: Scrubbing -->
  <script>
    const audioEl = document.getElementById('audio');
    const barEl   = document.getElementById('playerBar');

    audioEl.addEventListener('loadedmetadata', () => {
      const s = (window.state?.songs || []).find(x => x.id === window.state?.active);
      if (s) s.duration = Math.floor(audioEl.duration || 0);
    });

    barEl?.addEventListener('click', (e) => {
      const rect = barEl.getBoundingClientRect();
      const ratio = (e.clientX - rect.left) / rect.width;
      if (audioEl.duration > 0) audioEl.currentTime = ratio * audioEl.duration;
    });
  </script>

  <!-- Editor nur bei ?edit=1 -->
  <script>
    if (new URLSearchParams(location.search).get("edit") === "1") {
      var s = document.createElement("script");
      s.src = "/editor.js";
      document.body.appendChild(s);
    }
  </script>
</body>
</html>
