<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>R.A.L.F. ‚Äì Music Showcase</title>
  <meta name="description" content="R.A.L.F. ‚Äì Musik mit Kategorien, Cover-Galerie und integriertem Player." />
  <link rel="icon" type="image/png" href="/assets/favicon.png" />
  <meta property="og:title" content="R.A.L.F. ‚Äì Music Showcase" />
  <meta property="og:description" content="Stream deine Songs direkt auf deiner Seite, ohne Suno-Login." />
  <meta property="og:image" content="/assets/logo-512.png" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PWA / App-Icon -->
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/pwa/icon-180.png">
  <meta name="theme-color" content="#ea580c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    img, audio, video { -webkit-user-drag: none; user-select: none; }

    /* Pulsierende orange Linie */
    @keyframes pulseLine {
      0%, 100% { box-shadow: 0 0 0 rgba(234,88,12,0.0); }
      50%      { box-shadow: 0 0 16px rgba(234,88,12,0.35); }
    }
    .orange-sep {
      height: 4px;
      background: #ea580c;
      animation: pulseLine 3.2s ease-in-out infinite;
    }

    /* dezenter Hover-Glow f√ºr Karten und Buttons */
    .glow-hover:hover { box-shadow: 0 0 22px rgba(234,88,12,0.35); }

    /* Fallback: Download-Button im Audio verbergen (Browser-spezifisch) */
    audio::-internal-media-controls-download-button { display: none; }
    audio::-webkit-media-controls-enclosure { overflow: hidden; }
  </style>
</head>

<body class="min-h-screen bg-neutral-950 text-neutral-100">
  <!-- Banner -->
  <header class="relative w-full h-[180px] bg-black">
    <img src="/assets/logo-banner.png" alt="R.A.L.F. Banner"
         class="absolute inset-0 w-full h-full object-fill" />
  </header>

  <!-- dickere orange Trennlinie mit Puls -->
  <div class="orange-sep w-full"></div>

  <!-- Kopfbereich: Titel-Kachel + Suche -->
  <div class="max-w-7xl mx-auto px-4 mt-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div class="p-4 border border-orange-600 rounded-2xl">
      <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">R.A.L.F. ‚Äì Music Showcase</h1>
      <p class="text-neutral-400 text-sm">Musik von mir, f√ºr Euch.</p>
    </div>
    <div class="shrink-0 w-full sm:w-72">
      <input id="search" type="text" placeholder="Suche Songs"
             class="w-full rounded-2xl border border-orange-600 bg-neutral-800/80 px-4 py-2 text-sm text-white placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-orange-500 glow-hover">
    </div>
  </div>

  <!-- ‚ñ∂ Alles abspielen -->
  <div class="max-w-7xl mx-auto px-4 mt-3">
    <button id="playAllBtn"
      class="w-full sm:w-auto inline-flex items-center gap-2 bg-orange-600 hover:bg-orange-500 text-white font-semibold rounded-full px-4 py-2 glow-hover">
      ‚ñ∂ Alles abspielen
    </button>
  </div>

  <!-- Kategorien-Leiste -->
  <div id="catBar" class="max-w-7xl mx-auto px-4 mt-6 flex flex-wrap gap-2"></div>

  <!-- Kategorien-Galerie (nur bei "Alle" und leerer Suche) -->
  <section id="catGallery" class="max-w-6xl mx-auto px-4 py-8 hidden">
    <h2 class="text-lg font-bold mb-4">Kategorien</h2>
    <div id="catGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6 mb-10"></div>
  </section>

  <!-- Songs -->
  <main class="max-w-6xl mx-auto px-4 pb-24 mt-8 sm:mt-10">
    <div id="songsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
    <p id="emptyState" class="text-neutral-400 hidden mt-6">Keine Treffer. Suchbegriff anpassen.</p>
  </main>

  <!-- Player-Dock -->
  <div id="playerDock" class="fixed left-0 right-0 bottom-0 bg-neutral-900/95 backdrop-blur border-t border-neutral-800 hidden">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-4">
      <img id="playerCover" class="w-12 h-12 rounded-lg object-cover" alt="">
      <div class="flex-1 min-w-0">
        <div class="flex items-center justify-between gap-2">
          <div class="min-w-0">
            <div id="playerTitle" class="text-sm font-semibold truncate"></div>
            <div id="playerArtist" class="text-xs text-neutral-400 truncate"></div>
          </div>
          <div class="text-[11px] text-neutral-400 shrink-0" id="queuePos" aria-label="Position in Warteschlange"></div>
        </div>
        <div id="playerBar" class="mt-2 h-1.5 bg-neutral-700 rounded-full overflow-hidden cursor-pointer">
          <div id="playerProgress" class="h-full bg-orange-500" style="width:0%"></div>
        </div>
      </div>

      <!-- Neue Controls -->
      <div class="flex items-center gap-2">
        <button id="prevBtn" class="px-2 py-1.5 rounded-lg border border-neutral-700 hover:border-neutral-500">‚èÆ</button>
        <button id="nextBtn" class="px-2 py-1.5 rounded-lg border border-neutral-700 hover:border-neutral-500">‚è≠</button>
        <button id="shuffleBtn"
          class="px-2 py-1.5 rounded-lg border border-neutral-700 hover:border-neutral-500"
          title="Shuffle umschalten">üîÄ</button>
      </div>

      <audio id="audio" controls controlsList="nodownload" class="w-64" preload="metadata"></audio>
      <button id="closeBtn" class="px-3 py-1.5 text-sm rounded-lg border border-neutral-700 hover:border-neutral-500">Schlie√üen</button>
    </div>
  </div>

  <!-- Footer -->
  <footer class="border-t border-neutral-800">
    <div class="max-w-6xl mx-auto px-4 py-8 text-xs text-neutral-500 flex justify-between">
      <span>¬© R.A.L.F. ‚Äì Alle Rechte vorbehalten. Streaming-only. Downloads deaktiviert.</span>
      <span>v4.5 ¬∑ Category Play</span>
    </div>
  </footer>

  <!-- App-Logik -->
  <script>
    const state = {
      songs: [],
      categories: [],
      cat: 'all',
      query: '',
      active: null,
      queue: [],         // array of song ids
      queueIndex: -1,    // current index in queue
      shuffle: false
    };

    // lokale Overrides aus Editor (optional ‚Äì aktuell erlaubt)
    function loadLocalOverrides() {
      const s = localStorage.getItem('ralf_songs_json');
      const c = localStorage.getItem('ralf_categories_json');
      if (s) {
        try { const js = JSON.parse(s); state.songs = Array.isArray(js) ? js : (js.songs || []); } catch {}
      }
      if (c) {
        try { const jc = JSON.parse(c); state.categories = Array.isArray(jc) ? jc : (jc.categories || []); } catch {}
      }
    }

    // Daten laden
    async function loadData() {
      try { state.shuffle = localStorage.getItem('ralf_shuffle') === '1'; } catch {}

      loadLocalOverrides();

      if (!state.songs.length) {
        try {
          const s = await fetch('/songs.json').then(r => r.json());
          state.songs = Array.isArray(s) ? s : (s.songs || []);
        } catch(e) { console.error('songs.json Fehler', e); }
      }
      if (!state.categories.length) {
        try {
          const c = await fetch('/categories.json').then(r => r.json());
          state.categories = Array.isArray(c) ? c : (c.categories || []);
        } catch(e) { console.error('categories.json Fehler', e); }
      }

      applyQueryFromURL();
      render();

      // Deep-Link ?id=
      const pid = new URLSearchParams(location.search).get('id');
      if (pid) {
        const s = state.songs.find(x => x.id === pid);
        if (s) {
          ensureQueueForVisible();
          const pos = state.queue.findIndex(id => id === s.id);
          if (pos >= 0) state.queueIndex = pos;
          setTimeout(() => playSong(s), 150);
        }
      }
      updateShuffleButton();
    }

    function applyQueryFromURL() {
      const p = new URLSearchParams(location.search);
      state.cat = p.get('cat') || 'all';
      state.query = (p.get('q') || '').toLowerCase();
      const search = document.getElementById('search');
      if (search) search.value = state.query;
    }

    function setCat(cat) {
      state.cat = cat;
      const p = new URLSearchParams(location.search);
      p.set('cat', cat);
      history.replaceState(null, '', '?' + p.toString());
      render();
      state.queue = []; state.queueIndex = -1;
    }

    function setQuery(q) {
      state.query = (q || '').toLowerCase();
      const p = new URLSearchParams(location.search);
      if (state.query) p.set('q', state.query); else p.delete('q');
      history.replaceState(null, '', '?' + p.toString());
      render();
      state.queue = []; state.queueIndex = -1;
    }

    // Sichtbare Songs (Filter)
    function getVisibleSongs() {
      const q = state.query;
      return (state.songs || []).filter(s =>
        (state.cat === 'all' || s.category === state.cat) &&
        (!q || (s.title || '').toLowerCase().includes(q) || (s.artist || '').toLowerCase().includes(q))
      );
    }

    function songsByCategory(key) {
      return (state.songs || []).filter(s => s.category === key);
    }

    function ensureQueueForVisible() {
      const vis = getVisibleSongs();
      let ids = vis.map(s => s.id);
      if (state.shuffle) ids = shuffleArray(ids);
      state.queue = ids;
      state.queueIndex = ids.length ? 0 : -1;
      updateQueuePos();
    }

    function startQueueFromVisible() {
      ensureQueueForVisible();
      if (state.queueIndex === -1) return;
      const firstId = state.queue[state.queueIndex];
      const song = state.songs.find(x => x.id === firstId);
      if (song) playSong(song);
    }

    function startQueueForCategory(key) {
      // unabh√§ngig von der Suche: wirklich alle der Kategorie
      let ids = songsByCategory(key).map(s => s.id);
      if (!ids.length) return;
      if (state.shuffle) ids = shuffleArray(ids);
      state.queue = ids;
      state.queueIndex = 0;
      const first = state.songs.find(x => x.id === ids[0]);
      if (first) playSong(first);
      updateQueuePos();
    }

    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function next() {
      if (!state.queue.length) return;
      if (state.queueIndex < state.queue.length - 1) {
        state.queueIndex++;
        const id = state.queue[state.queueIndex];
        const s = state.songs.find(x => x.id === id);
        if (s) playSong(s);
      }
      updateQueuePos();
    }

    function prev() {
      if (!state.queue.length) return;
      if (state.queueIndex > 0) {
        state.queueIndex--;
        const id = state.queue[state.queueIndex];
        const s = state.songs.find(x => x.id === id);
        if (s) playSong(s);
      }
      updateQueuePos();
    }

    function toggleShuffle() {
      state.shuffle = !state.shuffle;
      try { localStorage.setItem('ralf_shuffle', state.shuffle ? '1' : '0'); } catch {}
      // Queue neu aufbauen und auf aktuellem Track bleiben, wenn m√∂glich
      const currentId = state.active;
      let ids = state.queue.slice();
      if (!ids.length) ids = getVisibleSongs().map(s => s.id);
      ids = state.shuffle ? shuffleArray(ids) : ids; // bei Ausschalten Reihenfolge beibehalten
      state.queue = ids;
      const pos = state.queue.findIndex(id => id === currentId);
      state.queueIndex = pos >= 0 ? pos : (state.queue.length ? 0 : -1);
      updateQueuePos();
      updateShuffleButton();
    }

    function updateShuffleButton() {
      const btn = document.getElementById('shuffleBtn');
      if (!btn) return;
      btn.className = 'px-2 py-1.5 rounded-lg border ' +
        (state.shuffle
          ? 'border-orange-500 bg-orange-600/20 text-white'
          : 'border-neutral-700 hover:border-neutral-500');
      btn.title = state.shuffle ? 'Shuffle ist an' : 'Shuffle umschalten';
    }

    function updateQueuePos() {
      const el = document.getElementById('queuePos');
      if (!el) return;
      if (!state.queue.length || state.queueIndex < 0) { el.textContent = ''; return; }
      el.textContent = (state.queueIndex + 1) + ' / ' + state.queue.length;
    }

    // Kategorien-Leiste (mit Abspiel-Button je Kategorie)
    function renderCatBar() {
      const bar = document.getElementById('catBar');
      bar.innerHTML = '';

      // "Alle" Chip (ohne Extra-Play, daf√ºr gibt's den gro√üen Button)
      const allWrap = document.createElement('div');
      allWrap.className = 'flex items-center gap-1';
      const allBtn = document.createElement('button');
      allBtn.textContent = 'Alle';
      allBtn.className =
        'px-3 py-1.5 rounded-full border text-sm transition glow-hover ' +
        (state.cat === 'all'
          ? 'bg-orange-600 border-orange-500 text-white'
          : 'bg-neutral-900 border-orange-600 text-neutral-200 hover:border-orange-500');
      allBtn.onclick = () => setCat('all');
      allWrap.appendChild(allBtn);
      bar.appendChild(allWrap);

      // Kategorien mit kleinem ‚ñ∂
      state.categories.forEach(c => {
        const wrap = document.createElement('div');
        wrap.className = 'flex items-center gap-1';

        const chip = document.createElement('button');
        chip.textContent = c.label || c.key;
        chip.className =
          'px-3 py-1.5 rounded-full border text-sm transition glow-hover ' +
          (state.cat === c.key
            ? 'bg-orange-600 border-orange-500 text-white'
            : 'bg-neutral-900 border-orange-600 text-neutral-200 hover:border-orange-500');
        chip.onclick = () => setCat(c.key);

        const play = document.createElement('button');
        play.innerText = '‚ñ∂';
        play.title = 'Kategorie abspielen';
        play.className =
          'px-2 py-1 rounded-full border text-sm ' +
          'bg-orange-600 text-white border-orange-500 hover:bg-orange-500 glow-hover';
        play.onclick = (e) => {
          e.stopPropagation();
          startQueueForCategory(c.key);
        };

        wrap.appendChild(chip);
        wrap.appendChild(play);
        bar.appendChild(wrap);
      });
    }

    // Kategorien-Galerie
    function renderCategoryGallery() {
      const showGallery = state.cat === 'all' && !state.query;
      const section = document.getElementById('catGallery');
      section.classList.toggle('hidden', !showGallery);
      if (!showGallery) return;

      const grid = document.getElementById('catGrid');
      grid.innerHTML = '';
      state.categories.forEach(c => {
        const card = document.createElement('div');
        card.className =
          'group relative cursor-pointer rounded-2xl overflow-hidden border border-orange-600 hover:border-orange-500 glow-hover';
        card.onclick = () => setCat(c.key);
        card.innerHTML = `
          <img src="${c.cover || '/assets/pwa/icon-512.png'}" alt="${c.label || c.key}"
               class="w-full h-32 object-contain bg-black" />
          <div class="absolute inset-0 bg-black/50 flex items-center justify-center">
            <span class="font-semibold text-white text-sm sm:text-base">${c.label || c.key}</span>
          </div>`;
        grid.appendChild(card);
      });
    }

    // Songs rendern
    function renderSongs() {
      const labelByKey = new Map((state.categories || []).map(c => [c.key, c.label || c.key]));
      const grid = document.getElementById('songsGrid');
      const empty = document.getElementById('emptyState');
      grid.innerHTML = '';

      const filtered = getVisibleSongs();

      if (!filtered.length) {
        empty.classList.remove('hidden');
        return;
      } else empty.classList.add('hidden');

      filtered.forEach(s => {
        const card = document.createElement('div');
        card.className =
          'group bg-neutral-900/70 border border-orange-600 rounded-2xl overflow-hidden hover:border-orange-500 transition glow-hover';
        card.innerHTML = `
          <div class="aspect-[3/4] overflow-hidden relative">
            <img src="${s.cover}" alt="${s.title}"
                 class="w-full h-full object-cover group-hover:scale-105 transition" />
          </div>
          <div class="p-4">
            <div class="text-xs text-neutral-300 mb-1">${labelByKey.get(s.category) || s.category || ''}</div>
            <h3 class="font-semibold leading-tight">${s.title}</h3>
            <div class="text-sm text-neutral-400">${s.artist || ''}</div>
            <div class="mt-3 flex justify-end">
              <button class="play bg-orange-600 text-white text-sm font-semibold rounded-full px-3 py-1.5 shadow hover:bg-orange-500 glow-hover">
                ‚ñ∂ Abspielen
              </button>
            </div>
          </div>`;
        card.querySelector('.play').onclick = () => {
          ensureQueueForVisible();
          const pos = state.queue.findIndex(id => id === s.id);
          state.queueIndex = pos >= 0 ? pos : 0;
          playSong(s);
        };
        grid.appendChild(card);
      });
    }

    function render() {
      renderCatBar();
      renderCategoryGallery();
      renderSongs();
    }

    // Player
    function playSong(s) {
      state.active = s.id;
      document.getElementById('playerDock').classList.remove('hidden');
      document.getElementById('playerCover').src = s.cover || '';
      document.getElementById('playerTitle').textContent = s.title || '';
      document.getElementById('playerArtist').textContent = s.artist || '';
      const audio = document.getElementById('audio');
      audio.src = s.src;
      audio.play().catch(() => {});
      audio.ontimeupdate = () => {
        const base = s.duration || audio.duration || 1;
        const pct = Math.min(100, Math.round((audio.currentTime / base) * 100));
        document.getElementById('playerProgress').style.width = pct + '%';
      };
      audio.onended = () => next();

      // Deep link aktualisieren
      const p = new URLSearchParams(location.search);
      p.set('id', s.id);
      history.replaceState(null, '', '?' + p.toString());

      // Queue-Position synchronisieren
      const pos = state.queue.findIndex(id => id === s.id);
      if (pos >= 0) state.queueIndex = pos;
      updateQueuePos();
    }

    // Close player
    document.getElementById('closeBtn').onclick = () => {
      document.getElementById('playerDock').classList.add('hidden');
      document.getElementById('audio').pause();
    };

    // Scrub
    (function enableScrub(){
      const audio = document.getElementById('audio');
      const bar = document.getElementById('playerBar');
      if (!bar) return;
      bar.addEventListener('click', (e) => {
        const rect = bar.getBoundingClientRect();
        const ratio = (e.clientX - rect.left) / rect.width;
        if (audio.duration > 0) audio.currentTime = ratio * audio.duration;
      });
    })();

    // Suche
    document.getElementById('search').addEventListener('input', (e) => setQuery(e.target.value));
    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
        e.preventDefault();
        const inp = document.getElementById('search'); inp.focus(); inp.select();
      }
    });

    // ‚ñ∂ Alles abspielen
    document.getElementById('playAllBtn').addEventListener('click', () => startQueueFromVisible());

    // Player Buttons
    document.getElementById('prevBtn').addEventListener('click', prev);
    document.getElementById('nextBtn').addEventListener('click', next);
    document.getElementById('shuffleBtn').addEventListener('click', toggleShuffle);

    // Editor nur laden, wenn ?edit=1
    (function maybeLoadEditor(){
      if (new URLSearchParams(location.search).get("edit") === "1") {
        var s = document.createElement("script");
        s.src = "/editor.js?v=4.3";
        document.body.appendChild(s);
      }
    })();

    // Start
    loadData();
  </script>
</body>
</html>
