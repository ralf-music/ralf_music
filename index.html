<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>R.A.L.F. – Music Showcase</title>
  <meta name="description" content="R.A.L.F. – Musik mit Kategorien, Cover-Galerie und integriertem Player." />
  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <meta property="og:title" content="R.A.L.F. – Music Showcase" />
  <meta property="og:description" content="Stream deine Songs direkt auf deiner Seite, ohne Suno-Login." />
  <meta property="og:image" content="assets/logo-512.png" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    img, audio, video { -webkit-user-drag: none; user-select: none; }

    /* Pulsierende, dezente, orange Trennlinie (Herzschlag) */
    .pulse-line {
      border: 0;
      height: 4px;
      background: #ea580c;         /* orange-600 */
      opacity: 0.85;
      animation: pulseGlow 2s ease-in-out infinite;
      box-shadow: 0 0 6px rgba(234, 88, 12, .35);
    }
    @keyframes pulseGlow {
      0%, 100% { opacity: .85; box-shadow: 0 0 6px rgba(234, 88, 12, .35); }
      50%      { opacity: 1;   box-shadow: 0 0 14px rgba(234, 88, 12, .55); }
    }
  </style>
</head>
<body class="min-h-screen bg-neutral-950 text-neutral-100">
  <!-- Banner -->
  <header class="relative w-full h-[180px] bg-black">
    <img src="/assets/logo-banner.png" alt="R.A.L.F. Banner"
         class="absolute inset-0 w-full h-full object-fill" />
  </header>

  <!-- Trennlinie -->
  <hr class="pulse-line my-4" />

  <!-- Kopf: Titel-Kachel + Suche -->
  <div class="max-w-7xl mx-auto px-4 mt-4 flex flex-wrap items-start justify-between gap-4">
    <!-- Kachel -->
    <div class="inline-block rounded-2xl border border-orange-600/35 px-4 py-3 bg-neutral-900/50">
      <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">R.A.L.F. – Music Showcase</h1>
      <p class="text-neutral-300 text-sm">Musik von mir, für Euch.</p>
    </div>

    <!-- Suche: mobil 100%, ab sm kompakt rechts -->
    <div class="w-full sm:w-64 md:w-72 lg:w-80 sm:ml-auto">
      <input id="search" type="text" placeholder="Suche Songs"
        class="w-full rounded-2xl bg-neutral-800/80 border border-orange-600/35 ring-1 ring-white/10 px-4 py-2 text-sm text-white placeholder-neutral-400
               focus:outline-none focus:ring-2 focus:ring-orange-500/60 focus:border-orange-500/60
               hover:ring-orange-500/20
               drop-shadow-[0_0_0_rgba(0,0,0,0)]
               focus:drop-shadow-[0_0_0.65rem_rgba(249,115,22,0.35)]">
    </div>
  </div>

  <!-- Kategorien-Leiste -->
  <div id="catBar" class="max-w-7xl mx-auto px-4 mt-8 mb-8 flex flex-wrap gap-2"></div>

  <section id="catGallery" class="max-w-6xl mx-auto px-4 py-10 hidden">
    <h2 class="text-lg font-bold mb-4">Kategorien</h2>
    <div id="catGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6 mb-10"></div>
  </section>

  <main class="max-w-6xl mx-auto px-4 pb-24">
    <div id="songsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
    <p id="emptyState" class="text-neutral-400 hidden">Keine Treffer. Suchbegriff anpassen.</p>
  </main>

  <!-- Player -->
  <div id="playerDock" class="fixed left-0 right-0 bottom-0 bg-neutral-900/95 backdrop-blur border-t border-neutral-800 hidden">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-4">
      <img id="playerCover" class="w-12 h-12 rounded-lg object-cover" />
      <div class="flex-1 min-w-0">
        <div id="playerTitle" class="text-sm font-semibold truncate"></div>
        <div id="playerArtist" class="text-xs text-neutral-400 truncate"></div>
        <div id="playerBar" class="mt-2 h-1.5 bg-neutral-700 rounded-full overflow-hidden cursor-pointer">
          <div id="playerProgress" class="h-full bg-orange-500" style="width:0%"></div>
        </div>
      </div>
      <audio id="audio" controls class="w-64" preload="metadata"></audio>
      <button id="closeBtn" class="px-3 py-1.5 text-sm rounded-lg border border-neutral-700 hover:border-neutral-500">Schließen</button>
    </div>
  </div>

  <!-- Footer mit Version -->
  <footer class="border-t border-neutral-800">
    <div class="max-w-6xl mx-auto px-4 py-8 text-xs text-neutral-500 flex items-center justify-between">
      <div>© R.A.L.F. – Alle Rechte vorbehalten. Streaming-only. Downloads deaktiviert.</div>
      <div class="text-neutral-500/80">v1.1.1 · Search Fit</div>
    </div>
  </footer>

  <script>
    const state = { songs: [], categories: [], cat: 'all', query: '', active: null };

    window.renderSite = function(songs, categories){
      if (songs) state.songs = Array.isArray(songs) ? songs : (songs.songs || []);
      if (categories) state.categories = Array.isArray(categories) ? categories : (categories.categories || []);
      render();
    };

    async function loadData() {
      const localSongs = localStorage.getItem('ralf_songs_json');
      const localCats  = localStorage.getItem('ralf_categories_json');
      if (localSongs) {
        try { const s = JSON.parse(localSongs); state.songs = Array.isArray(s) ? s : (s.songs || []); } catch(e){}
      }
      if (localCats) {
        try { const c = JSON.parse(localCats); state.categories = Array.isArray(c) ? c : (c.categories || []); } catch(e){}
      }
      if (!state.songs.length || !state.categories.length) {
        const s = await fetch('songs.json').then(r=>r.json());
        const c = await fetch('categories.json').then(r=>r.json());
        state.songs = Array.isArray(s) ? s : (s.songs || []);
        state.categories = Array.isArray(c) ? c : (c.categories || []);
      }
      renderCatBar();
      applyQueryFromURL();
      render();

      const pid = new URLSearchParams(location.search).get('id');
      if (pid) {
        const s = state.songs.find(x=>x.id===pid);
        if (s) setTimeout(()=>playSong(s), 100);
      }
    }

    function applyQueryFromURL() {
      const p = new URLSearchParams(location.search);
      state.cat = p.get('cat') || 'all';
      state.query = (p.get('q') || '').toLowerCase();
      const search = document.getElementById('search');
      if (search) search.value = state.query;
    }
    function setCat(cat) {
      state.cat = cat;
      const p = new URLSearchParams(location.search);
      p.set('cat', cat);
      history.replaceState(null, '', '?' + p.toString());
      render();
    }
    function setQuery(q) {
      state.query = (q || '').toLowerCase();
      const p = new URLSearchParams(location.search);
      if (q) p.set('q', q); else p.delete('q');
      history.replaceState(null, '', '?' + p.toString());
      render();
    }

    function getCategoryLabel(key) {
      const cat = state.categories.find(c => c.key === key);
      return cat ? (cat.label || cat.key) : key;
    }

    function renderCatBar() {
      const bar = document.getElementById('catBar');
      bar.innerHTML = '';

      const mkBtn = (label, active, onClick) => {
        const b = document.createElement('button');
        b.textContent = label;
        b.className =
          'px-3 py-1.5 rounded-full border border-orange-600/35 text-sm transition ' +
          (active
            ? 'bg-orange-600 border-orange-500 text-white ring-2 ring-orange-400/50 drop-shadow-[0_0_0.65rem_rgba(249,115,22,0.35)]'
            : 'bg-neutral-900 text-neutral-300 hover:border-orange-500/60 hover:ring-2 hover:ring-orange-400/40 hover:drop-shadow-[0_0_0.55rem_rgba(249,115,22,0.30)]');
        b.onclick = onClick;
        return b;
      };

      bar.appendChild(mkBtn('Alle', state.cat === 'all', () => setCat('all')));
      state.categories.forEach(c => {
        bar.appendChild(mkBtn(c.label || c.key, state.cat === c.key, () => setCat(c.key)));
      });
    }

    function renderCategoryGallery() {
      const showGallery = state.cat === 'all' && !state.query;
      const section = document.getElementById('catGallery');
      section.classList.toggle('hidden', !showGallery);
      if (!showGallery) return;

      const grid = document.getElementById('catGrid');
      grid.innerHTML = '';
      state.categories.forEach(c => {
        const card = document.createElement('div');
        card.className =
          'group relative cursor-pointer rounded-2xl overflow-hidden border border-orange-600/35 transition ' +
          'hover:border-orange-500/55 hover:drop-shadow-[0_0_0.7rem_rgba(249,115,22,0.30)]';
        card.onclick = () => setCat(c.key);
        card.innerHTML = `
          <img src="${c.cover}" alt="${c.label || c.key}" class="w-full h-32 object-cover bg-black" />
          <div class="absolute inset-0 bg-black/40 group-hover:bg-black/30 flex items-center justify-center transition">
            <span class="font-semibold text-white text-sm sm:text-base drop-shadow-[0_0_0.5rem_rgba(0,0,0,0.6)]">${c.label || c.key}</span>
          </div>`;
        grid.appendChild(card);
      });
    }

    function renderSongs() {
      const q = state.query;
      const filtered = state.songs.filter(s =>
        (state.cat === 'all' || s.category === state.cat) &&
        (!q || (s.title||'').toLowerCase().includes(q) || (s.artist||'').toLowerCase().includes(q))
      );

      const grid = document.getElementById('songsGrid');
      const empty = document.getElementById('emptyState');
      grid.innerHTML = '';

      if (filtered.length === 0) { empty.classList.remove('hidden'); return; }
      else empty.classList.add('hidden');

      filtered.forEach(s => {
        const card = document.createElement('div');
        card.className =
          'group bg-neutral-900/70 border border-orange-600/35 rounded-2xl overflow-hidden transition ' +
          'hover:border-orange-500/60 hover:drop-shadow-[0_0_0.9rem_rgba(249,115,22,0.30)]';
        card.innerHTML = `
  <div class="aspect-square overflow-hidden relative">
    <img src="${s.cover}" alt="${s.title}" class="w-full h-full object-cover group-hover:scale-105 transition" />
  </div>
  <div class="p-4">
    <div class="text-xs text-neutral-300 mb-1">${getCategoryLabel(s.category)}</div>
    <h3 class="font-semibold leading-tight">${s.title}</h3>
    <div class="text-sm text-neutral-400">${s.artist}</div>
    <div class="mt-3 flex justify-end">
      <button class="play bg-orange-600 text-white text-sm font-semibold rounded-full px-3 py-1.5 shadow
                     hover:bg-orange-500 hover:brightness-110
                     drop-shadow-[0_0_0.65rem_rgba(249,115,22,0.35)] hover:drop-shadow-[0_0_0.9rem_rgba(249,115,22,0.45)]">
        ▶ Abspielen
      </button>
    </div>
  </div>`;
        card.querySelector('.play').onclick = () => playSong(s);
        grid.appendChild(card);
      });
    }

    function playSong(s) {
      state.active = s.id;
      document.getElementById('playerDock').classList.remove('hidden');
      document.getElementById('playerCover').src = s.cover;
      document.getElementById('playerTitle').textContent = s.title;
      document.getElementById('playerArtist').textContent = s.artist;
      const audio = document.getElementById('audio');
      audio.src = s.src;
      audio.play().catch(() => {});
      audio.ontimeupdate = () => {
        const pct = Math.min(100, Math.round((audio.currentTime / (s.duration || 1)) * 100));
        document.getElementById('playerProgress').style.width = pct + '%';
      };
    }

    function render() {
      renderCatBar();
      renderCategoryGallery();
      renderSongs();
    }

    document.getElementById('closeBtn').onclick = () => {
      document.getElementById('playerDock').classList.add('hidden');
      document.getElementById('audio').pause();
    };
    document.getElementById('search').addEventListener('input', (e) => setQuery(e.target.value));
    window.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') { e.preventDefault(); document.getElementById('search').focus(); } });
    loadData();
  </script>

  <!-- Scrubbing -->
  <script>
    const audio = document.getElementById('audio');
    const bar   = document.getElementById('playerBar');

    audio.addEventListener('loadedmetadata', () => {
      const s = (window.state?.songs || []).find(x => x.id === window.state?.active);
      if (s) s.duration = Math.floor(audio.duration || 0);
    });

    bar?.addEventListener('click', (e) => {
      const rect = bar.getBoundingClientRect();
      const ratio = (e.clientX - rect.left) / rect.width;
      if (audio.duration > 0) audio.currentTime = ratio * audio.duration;
    });
  </script>

  <!-- Editor nur mit ?edit=1 -->
  <script>
    if (new URLSearchParams(location.search).get("edit") === "1") {
      var s = document.createElement("script");
      s.src = "/editor.js?v=4.2";
      document.body.appendChild(s);
    }
  </script>
</body>
</html>
