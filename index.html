<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>R.A.L.F. – Music Showcase</title>
  <meta name="description" content="R.A.L.F. – Musik mit Kategorien, Cover-Galerie und integriertem Player." />
  <link rel="icon" type="image/png" href="/assets/favicon.png" />
  <meta property="og:title" content="R.A.L.F. – Music Showcase" />
  <meta property="og:description" content="Stream deine Songs direkt auf deiner Seite, ohne Suno-Login." />
  <meta property="og:image" content="/assets/logo-512.png" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PWA / App-Icon -->
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/pwa/icon-180.png">
  <meta name="theme-color" content="#ea580c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    img, audio, video { -webkit-user-drag: none; user-select: none; }
    /* Pulsierende orange Linie */
    @keyframes pulseLine {
      0%, 100% { box-shadow: 0 0 0 rgba(234,88,12,0.0); }
      50%      { box-shadow: 0 0 16px rgba(234,88,12,0.35); }
    }
    .orange-sep {
      height: 4px;
      background: #ea580c;
      animation: pulseLine 3.2s ease-in-out infinite;
    }
    /* dezenter Hover-Glow */
    .glow-hover:hover { box-shadow: 0 0 22px rgba(234,88,12,0.35); }
    /* Safe-Area für Android */
    .player-dock-safe {
      padding-bottom: max(env(safe-area-inset-bottom), .5rem);
    }
    /* Größere Touch-Ziele */
    .btn-touch {
      min-width: 48px;
      min-height: 44px;
    }
  </style>
</head>

<body class="min-h-screen bg-neutral-950 text-neutral-100">
  <!-- Banner -->
  <header class="relative w-full h-[180px] bg-black">
    <img src="/assets/logo-banner.png" alt="R.A.L.F. Banner"
         class="absolute inset-0 w-full h-full object-fill" />
  </header>

  <!-- dickere orange Trennlinie mit Puls -->
  <div class="orange-sep w-full"></div>

  <!-- Kopfbereich -->
  <div class="max-w-7xl mx-auto px-4 mt-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div class="p-4 border border-orange-600 rounded-2xl">
      <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">R.A.L.F. – Music Showcase</h1>
      <p class="text-neutral-400 text-sm">Musik von mir, für Euch.</p>
    </div>
    <div class="shrink-0 w-full sm:w-72">
      <input id="search" type="text" placeholder="Suche Songs"
             class="w-full rounded-2xl border border-orange-600 bg-neutral-800/80 px-4 py-2 text-sm text-white placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-orange-500 glow-hover">
    </div>
  </div>

  <!-- Kategorien-Leiste -->
  <div id="catBar" class="max-w-7xl mx-auto px-4 mt-6 flex flex-wrap gap-2"></div>

  <!-- Kategorien-Galerie -->
  <section id="catGallery" class="max-w-6xl mx-auto px-4 py-8 hidden">
    <h2 class="text-lg font-bold mb-4">Kategorien</h2>
    <div id="catGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6 mb-10"></div>
  </section>

  <!-- Songs -->
  <main class="max-w-6xl mx-auto px-4 pb-24 mt-8 sm:mt-10">
    <div id="songsGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"></div>
    <p id="emptyState" class="text-neutral-400 hidden mt-6">Keine Treffer. Suchbegriff anpassen.</p>
  </main>

  <!-- Player-Dock -->
  <div id="playerDock" class="player-dock-safe fixed left-0 right-0 bottom-0 bg-neutral-900/95 backdrop-blur border-t border-neutral-800 hidden">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-4">
      <img id="playerCover" class="w-12 h-12 rounded-lg object-cover" alt="">

      <div class="flex-1 min-w-0">
        <div id="playerTitle" class="text-sm font-semibold truncate"></div>
        <div id="playerArtist" class="text-xs text-neutral-400 truncate"></div>
        <div id="playerBar" class="mt-2 h-1.5 bg-neutral-700 rounded-full overflow-hidden cursor-pointer">
          <div id="playerProgress" class="h-full bg-orange-500" style="width:0%"></div>
        </div>
      </div>

      <!-- Desktop: nativer Player -->
      <div class="hidden sm:block">
        <audio id="audio" controls controlslist="nodownload noplaybackrate" preload="metadata" class="w-64"></audio>
      </div>

      <!-- Mobile: eigene Steuerung -->
      <div class="flex items-center gap-2 sm:hidden">
        <button id="btnPrev" class="btn-touch px-2.5 py-1.5 rounded-full border border-orange-600 text-white bg-neutral-900 hover:border-orange-500">⏮</button>
        <button id="btnPlay" class="btn-touch px-3 py-1.5 rounded-full bg-orange-600 text-white font-semibold hover:bg-orange-500">▶</button>
        <button id="btnNext" class="btn-touch px-2.5 py-1.5 rounded-full border border-orange-600 text-white bg-neutral-900 hover:border-orange-500">⏭</button>
        <span id="playerCounter" class="text-xs text-neutral-400 min-w-[3.5rem] text-center">1 / 1</span>
      </div>

      <button id="closeBtn" class="px-3 py-1.5 text-sm rounded-lg border border-neutral-700 hover:border-neutral-500">Schließen</button>
    </div>
  </div>

  <!-- Footer -->
  <footer class="border-t border-neutral-800">
    <div class="max-w-6xl mx-auto px-4 py-8 text-xs text-neutral-500 flex justify-between">
      <span>© R.A.L.F. – Alle Rechte vorbehalten. Streaming-only. Downloads deaktiviert.</span>
      <span>v4.6</span>
    </div>
  </footer>

  <!-- App-Logik -->
  <script>
    const state = { songs: [], categories: [], cat: 'all', query: '', active: null, queue: [], queueIndex: -1, shuffle: false };

    // lokale Overrides (nur für Editor)
    function loadLocalOverrides() {
      const s = localStorage.getItem('ralf_songs_json');
      const c = localStorage.getItem('ralf_categories_json');
      if (s) { try { const js = JSON.parse(s); state.songs = Array.isArray(js) ? js : (js.songs || []); } catch {} }
      if (c) { try { const jc = JSON.parse(c); state.categories = Array.isArray(jc) ? jc : (jc.categories || []); } catch {} }
    }

    async function loadData() {
      loadLocalOverrides();
      if (!state.songs.length) {
        try { const s = await fetch('/songs.json').then(r=>r.json()); state.songs = Array.isArray(s) ? s : (s.songs||[]); } catch(e){}
      }
      if (!state.categories.length) {
        try { const c = await fetch('/categories.json').then(r=>r.json()); state.categories = Array.isArray(c) ? c : (c.categories||[]); } catch(e){}
      }
      applyQueryFromURL(); render();
      const pid = new URLSearchParams(location.search).get('id');
      if (pid) { const s = state.songs.find(x=>x.id===pid); if (s) setTimeout(()=>playSong(s),150); }
    }

    function applyQueryFromURL() {
      const p = new URLSearchParams(location.search);
      state.cat = p.get('cat') || 'all';
      state.query = (p.get('q') || '').toLowerCase();
      const search = document.getElementById('search'); if (search) search.value = state.query;
    }

    function setCat(cat) {
      state.cat = cat;
      const p = new URLSearchParams(location.search);
      p.set('cat', cat); history.replaceState(null,'','?'+p.toString()); render();
    }
    function setQuery(q) {
      state.query = (q||'').toLowerCase();
      const p = new URLSearchParams(location.search);
      if (state.query) p.set('q', state.query); else p.delete('q');
      history.replaceState(null,'','?'+p.toString()); render();
    }

    // Kategorien
    function renderCatBar() {
      const bar=document.getElementById('catBar'); bar.innerHTML='';
      const allBtn=document.createElement('button');
      allBtn.textContent='Alle';
      allBtn.className='px-3 py-1.5 rounded-full border text-sm transition glow-hover '+(state.cat==='all'?'bg-orange-600 border-orange-500 text-white':'bg-neutral-900 border-orange-600 text-neutral-200 hover:border-orange-500');
      allBtn.onclick=()=>setCat('all'); bar.appendChild(allBtn);
      state.categories.forEach(c=>{
        const b=document.createElement('button');
        b.textContent=c.label||c.key;
        b.className='px-3 py-1.5 rounded-full border text-sm transition glow-hover '+(state.cat===c.key?'bg-orange-600 border-orange-500 text-white':'bg-neutral-900 border-orange-600 text-neutral-200 hover:border-orange-500');
        b.onclick=()=>setCat(c.key); bar.appendChild(b);
      });
    }

    function renderCategoryGallery() {
      const showGallery=state.cat==='all'&&!state.query;
      const section=document.getElementById('catGallery');
      section.classList.toggle('hidden',!showGallery);
      if(!showGallery) return;
      const grid=document.getElementById('catGrid'); grid.innerHTML='';
      state.categories.forEach(c=>{
        const card=document.createElement('div');
        card.className='group relative cursor-pointer rounded-2xl overflow-hidden border border-orange-600 hover:border-orange-500 glow-hover';
        card.onclick=()=>setCat(c.key);
        card.innerHTML=`
          <img src="${c.cover||'/assets/pwa/icon-512.png'}" alt="${c.label||c.key}" class="w-full h-32 object-contain bg-black"/>
          <div class="absolute inset-0 bg-black/50 flex items-center justify-center">
            <span class="font-semibold text-white text-sm sm:text-base">${c.label||c.key}</span>
          </div>`;
        grid.appendChild(card);
      });
    }

    function renderSongs() {
      const labelByKey=new Map((state.categories||[]).map(c=>[c.key,c.label||c.key]));
      const q=state.query;
      const grid=document.getElementById('songsGrid');
      const empty=document.getElementById('emptyState');
      grid.innerHTML='';
      const filtered=(state.songs||[]).filter(s=>(state.cat==='all'||s.category===state.cat)&&(!q||(s.title||'').toLowerCase().includes(q)||(s.artist||'').toLowerCase().includes(q)));
      if(!filtered.length){empty.classList.remove('hidden');return;} else empty.classList.add('hidden');
      filtered.forEach(s=>{
        const card=document.createElement('div');
        card.className='group bg-neutral-900/70 border border-orange-600 rounded-2xl overflow-hidden hover:border-orange-500 transition glow-hover';
        card.innerHTML=`
          <div class="aspect-[3/4] overflow-hidden relative">
            <img src="${s.cover}" alt="${s.title}" class="w-full h-full object-cover group-hover:scale-105 transition"/>
          </div>
          <div class="p-4">
            <div class="text-xs text-neutral-300 mb-1">${labelByKey.get(s.category)||s.category||''}</div>
            <h3 class="font-semibold leading-tight">${s.title}</h3>
            <div class="text-sm text-neutral-400">${s.artist||''}</div>
            <div class="mt-3 flex justify-end">
              <button class="play bg-orange-600 text-white text-sm font-semibold rounded-full px-3 py-1.5 shadow hover:bg-orange-500 glow-hover">▶ Abspielen</button>
            </div>
          </div>`;
        card.querySelector('.play').onclick=()=>playSong(s);
        grid.appendChild(card);
      });
    }

    function render(){renderCatBar();renderCategoryGallery();renderSongs();}

    // Queue/Player
    function buildQueue(){return(state.songs||[]).filter(s=>(state.cat==='all'||s.category===state.cat)&&(!state.query||(s.title||'').toLowerCase().includes(state.query)||(s.artist||'').toLowerCase().includes(state.query)));}

    function startQueue(shuffle=false){
      const list=buildQueue(); if(!list.length)return;
      state.queue=shuffle?list.sort(()=>Math.random()-0.5):list;
      state.queueIndex=0; playSong(state.queue[0]);
    }

    function playSong(s){
      state.active=s.id;
      if(state.queue.length===0){state.queue=[s];state.queueIndex=0;}
      else{state.queueIndex=state.queue.findIndex(x=>x.id===s.id);}
      document.getElementById('playerDock').classList.remove('hidden');
      document.getElementById('playerCover').src=s.cover||'';
      document.getElementById('playerTitle').textContent=s.title||'';
      document.getElementById('playerArtist').textContent=s.artist||'';
      const audio=document.getElementById('audio'); audio.src=s.src; audio.play().catch(()=>{});
      audio.ontimeupdate=()=>{const pct=Math.min(100,Math.round((audio.currentTime/(s.duration||Math.max(audio.duration||1,1)))*100));document.getElementById('playerProgress').style.width=pct+'%';};
      audio.onended=()=>playNext();
      const p=new URLSearchParams(location.search); p.set('id',s.id); history.replaceState(null,'','?'+p.toString());
      window.__updateMobileCounter&&window.__updateMobileCounter(); window.__updateMobilePlayIcon&&window.__updateMobilePlayIcon();
    }

    function playNext(){if(state.queueIndex<state.queue.length-1){state.queueIndex++;playSong(state.queue[state.queueIndex]);}}
    function playPrev(){if(state.queueIndex>0){state.queueIndex--;playSong(state.queue[state.queueIndex]);}}

    document.getElementById('closeBtn').onclick=()=>{document.getElementById('playerDock').classList.add('hidden');document.getElementById('audio').pause();};

    (function enableScrub(){const audio=document.getElementById('audio');const bar=document.getElementById('playerBar');if(!bar)return;bar.addEventListener('click',e=>{const rect=bar.getBoundingClientRect();const ratio=(e.clientX-rect.left)/rect.width;if(audio.duration>0)audio.currentTime=ratio*audio.duration;});})();

    document.getElementById('search').addEventListener('input',e=>setQuery(e.target.value));
    window.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='k'){e.preventDefault();const inp=document.getElementById('search');inp.focus();inp.select();}});

    // Mobile Controls
    (function wireMobilePlayer(){
      const audio=document.getElementById('audio');
      const btnPrev=document.getElementById('btnPrev');
      const btnPlay=document.getElementById('btnPlay');
      const btnNext=document.getElementById('btnNext');
      const counter=document.getElementById('playerCounter');
      if(!audio||!btnPlay)return;
      btnPlay.onclick=()=>{if(audio.paused)audio.play().catch(()=>{});else audio.pause();};
      btnPrev&&(btnPrev.onclick=()=>{if(window.playPrev)playPrev();});
      btnNext&&(btnNext.onclick=()=>{if(window.playNext)playNext();});
      function updatePlayIcon(){btnPlay.textContent=audio.paused?'▶':'⏸';}
      function updateCounter(){try{const len=(state.queue&&state.queue.length)?state.queue.length:1;const idx=(typeof state.queueIndex==='number'?state.queueIndex:0)+1;counter.textContent=`${idx} / ${len}`;}catch{counter.textContent='1 / 1';}}
      audio.addEventListener('play',()=>{updatePlayIcon();updateCounter();});
      audio.addEventListener('pause',()=>{updatePlayIcon();});
      audio.addEventListener('ended',()=>{updatePlayIcon();});
      window.__updateMobileCounter=updateCounter; window.__updateMobilePlayIcon=updatePlayIcon;
    })();

    (function maybeLoadEditor(){if(new URLSearchParams(location.search).get("edit")==="1"){var s=document.createElement("script");s.src="/editor.js?v=4.6";document.body.appendChild(s);}})();

    loadData();
  </script>
</body>
</html>
