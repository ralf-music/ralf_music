<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kontakt (Test) – R.A.L.F.</title>
  <meta name="description" content="Kontakt – Feedback, Fehler melden, Lizenzanfragen." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{background:rgba(23,23,23,.72);border:1px solid #ea580c;border-radius:1rem}
    .hint{font-size:.75rem}
    .hidden-robot{position:absolute!important;left:-10000px!important;top:auto!important;width:1px!important;height:1px!important;overflow:hidden!important}
  </style>
</head>
<body class="min-h-screen bg-neutral-950 text-neutral-100">
  <div class="max-w-2xl mx-auto p-4 sm:p-6">
    <h1 class="text-2xl font-extrabold">Kontakt (Test)</h1>
    <p class="text-neutral-300 mt-1">Feedback, Fehler melden oder Lizenzanfrage.</p>

    <div id="status" class="mt-4 hidden"></div>

    <form id="contactForm" class="card p-4 sm:p-6 mt-6 space-y-4"
          action="https://formsubmit.co/ralf.music@web.de"
          method="POST" novalidate>
      <!-- FormSubmit Optionen -->
      <input type="hidden" name="_subject" value="[R.A.L.F. Kontakt] Neue Nachricht" />
      <input type="hidden" name="_template" value="table" />
      <input type="hidden" name="_captcha" value="false" />
      <input type="hidden" name="_next" value="" id="nextUrl" />
      <div class="hidden-robot">
        <label>Bitte frei lassen: <input type="text" name="_honey" autocomplete="off"></label>
      </div>

      <div>
        <label class="block text-sm mb-1">Kategorie</label>
        <select name="category" id="category" class="w-full rounded-lg bg-neutral-900 border border-neutral-700 px-3 py-2">
          <option value="Feedback">Feedback</option>
          <option value="Bug">Bug</option>
          <option value="Lizenzanfrage">Lizenzanfrage</option>
        </select>
      </div>

      <!-- SONG-AUSWAHL + PREVIEW -->
      <div>
        <div class="flex items-center justify-between">
          <label class="block text-sm mb-1">Song (optional)</label>
          <button type="button" id="previewToggle"
                  class="text-xs px-2 py-1 rounded border border-neutral-700 hover:border-neutral-500">
            Vorschau
          </button>
        </div>
        <select name="song" id="song" class="w-full rounded-lg bg-neutral-900 border border-neutral-700 px-3 py-2">
          <option value="">— keiner —</option>
        </select>
        <p class="hint text-neutral-400 mt-1">Titel + Kategorie; Vorschau zeigt das Cover.</p>

        <!-- Preview-Box -->
        <div id="songPreview" class="hidden mt-2 p-2 rounded-lg border border-neutral-800 bg-neutral-900/60">
          <div class="flex items-center gap-3">
            <img id="songPreviewImg" src="" alt="Cover" class="w-12 h-12 rounded object-cover ring-1 ring-white/10">
            <div class="min-w-0">
              <div id="songPreviewTitle" class="text-sm font-medium truncate"></div>
              <div id="songPreviewMeta" class="text-xs text-neutral-400 truncate"></div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <label class="block text-sm mb-1">Betreff (optional)</label>
        <input name="subject" id="subject" class="w-full rounded-lg bg-neutral-900 border border-neutral-700 px-3 py-2" />
      </div>

      <div>
        <label class="block text-sm mb-1">Nachricht <span class="text-neutral-400">(mind. 20 Zeichen)</span></label>
        <textarea name="message" id="message" rows="6"
                  class="w-full rounded-lg bg-neutral-900 border border-neutral-700 px-3 py-2"
                  placeholder="Was ist los?"></textarea>
        <div class="flex justify-between items-center mt-1">
          <p class="hint text-neutral-400">Strg/⌘+Enter zum Senden</p>
          <p class="hint text-neutral-400"><span id="count">0</span>/4000</p>
        </div>
      </div>

      <div>
        <label class="block text-sm mb-1">E-Mail für Antwort</label>
        <input type="email" name="email" id="reply_to" required
               class="w-full rounded-lg bg-neutral-900 border border-neutral-700 px-3 py-2"
               placeholder="dein.name@example.com" />
      </div>

      <div class="flex items-start gap-2">
        <input type="checkbox" id="consent" class="mt-1">
        <label for="consent" class="text-sm text-neutral-300">
          Ich stimme zu, dass meine Angaben zur Kontaktaufnahme gespeichert und per E-Mail an R.A.L.F. übermittelt werden.
        </label>
      </div>

      <div class="pt-2 flex gap-3">
        <button id="sendBtn" class="bg-orange-600 hover:bg-orange-500 text-white font-semibold rounded-full px-4 py-2">
          Senden
        </button>
        <a id="mailtoFallback" class="text-sm text-neutral-400 underline underline-offset-4" href="#">
          Oder E-Mail öffnen
        </a>
      </div>
    </form>
  </div>

  <script>
    // Erfolgsmeldung
    (function(){
      const p=new URLSearchParams(location.search);
      if(p.get('ok')==='1'){
        const el=document.getElementById('status');
        el.className='mt-4 p-3 rounded-lg border border-green-700 bg-green-900/30 text-green-200';
        el.textContent='Danke! Deine Nachricht wurde gesendet.';
        el.classList.remove('hidden');
        history.replaceState(null,'',location.pathname);
      }
    })();

    // _next setzen
    (function(){
      const here = location.origin + location.pathname + '?ok=1';
      const next = document.getElementById('nextUrl');
      if(next) next.value = here;
    })();

    // Kategorien + Songs laden, Dropdown befüllen (Titel + Kategorie), Preview ermöglichen
    const songSel = document.getElementById('song');
    const preview = {
      box:   document.getElementById('songPreview'),
      img:   document.getElementById('songPreviewImg'),
      title: document.getElementById('songPreviewTitle'),
      meta:  document.getElementById('songPreviewMeta')
    };
    const previewToggle = document.getElementById('previewToggle');

    const songById = new Map();

    async function loadSongsAndCats(){
      try{
        const [sRes, cRes] = await Promise.all([
          fetch('/songs.json'),
          fetch('/categories.json')
        ]);
        const sData = await sRes.json();
        const cData = await cRes.json();

        const songs = Array.isArray(sData) ? sData : (sData.songs || []);
        const cats  = Array.isArray(cData) ? cData : (cData.categories || []);
        const labelByKey = new Map(cats.map(c => [c.key, c.label || c.key]));

        songs.forEach(s=>{
          songById.set(s.id, s);
          const opt=document.createElement('option');
          const catLabel = labelByKey.get(s.category) || s.category || '';
          opt.value = s.id || '';
          opt.textContent = s.title ? `${s.title} — ${catLabel}` : (catLabel || '');
          songSel.appendChild(opt);
        });

        updatePreview();
      }catch(_){}
    }

    function updatePreview(){
      const id = songSel.value;
      if(!id){ preview.box.classList.add('hidden'); return; }
      const s = songById.get(id);
      if(!s){ preview.box.classList.add('hidden'); return; }
      preview.img.src = s.cover || '';
      preview.title.textContent = s.title || '';
      preview.meta.textContent  = [s.artist || '', s.category ? `• ${s.category}` : ''].filter(Boolean).join(' ');
      preview.box.classList.remove('hidden');
    }

    songSel.addEventListener('change', updatePreview);
    previewToggle.addEventListener('click', ()=>{
      if(preview.box.classList.contains('hidden')) updatePreview();
      else preview.box.classList.add('hidden');
    });

    loadSongsAndCats();

    // Live-Counter & Validation
    const msg=document.getElementById('message');
    const cnt=document.getElementById('count');
    msg.addEventListener('input',()=>{ cnt.textContent = Math.min(4000, msg.value.length); });
    function isEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v||''); }

    // Mailto-Fallback
    (function(){
      const fb=document.getElementById('mailtoFallback');
      const to = 'ralf.music@web.de';
      fb.href = `mailto:${to}?subject=${encodeURIComponent('[R.A.L.F. Kontakt]')}`;
    })();

    // Submit-Checks
    const form=document.getElementById('contactForm');
    const btn=document.getElementById('sendBtn');
    form.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); btn.click(); }});
    form.addEventListener('submit',(e)=>{
      const email = document.getElementById('reply_to').value.trim();
      const okLen = (msg.value.trim().length >= 20 && msg.value.length <= 4000);
      const okMail = isEmail(email);
      const okConsent = document.getElementById('consent').checked;
      if(!okLen || !okMail || !okConsent){
        e.preventDefault();
        let err=[]; if(!okLen) err.push('Nachricht zu kurz (mind. 20 Zeichen).');
        if(!okMail) err.push('Bitte gültige E-Mail eingeben.');
        if(!okConsent) err.push('Bitte der Speicherung/Übermittlung zustimmen.');
        alert(err.join('\n')); return false;
      }
      btn.disabled=true; btn.textContent='Sende…';
      setTimeout(()=>{ btn.disabled=false; btn.textContent='Senden'; },6000);
    });
  </script>
</body>
</html>
