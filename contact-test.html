<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kontakt (Test) – R.A.L.F.</title>
  <meta name="description" content="Kontakt – Feedback, Fehler melden, Lizenzanfragen." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{background:rgba(23,23,23,.72);border:1px solid #ea580c;border-radius:1rem}
    .hint{font-size:.75rem}
    .hidden-robot{position:absolute!important;left:-10000px!important;top:auto!important;width:1px!important;height:1px!important;overflow:hidden!important}
  </style>
</head>
<body class="min-h-screen bg-neutral-950 text-neutral-100">
  <div class="max-w-2xl mx-auto p-4 sm:p-6">
    <h1 class="text-2xl font-extrabold">Kontakt (Test)</h1>
    <p class="text-neutral-300 mt-1">Feedback, Fehler melden oder Lizenzanfrage.</p>

    <div id="status" class="mt-4 hidden"></div>

    <form id="contactForm" class="card p-4 sm:p-6 mt-6 space-y-4"
          action="https://formsubmit.co/YOUR_EMAIL_HERE"
          method="POST" novalidate>
      <!-- FormSubmit Optionen -->
      <input type="hidden" name="_subject" value="[R.A.L.F. Kontakt] Neue Nachricht" />
      <input type="hidden" name="_template" value="table" />
      <input type="hidden" name="_captcha" value="false" />
      <!-- Nach erfolgreichem Senden auf diese Seite zurück mit ?ok=1 -->
      <input type="hidden" name="_next" value="" id="nextUrl" />
      <!-- Honeypot -->
      <div class="hidden-robot">
        <label>Bitte frei lassen: <input type="text" name="_honey" autocomplete="off"></label>
      </div>

      <div>
        <label class="block text-sm mb-1">Kategorie</label>
        <select name="category" id="category" class="w-full rounded-lg bg-neutral-900 border border-neutral-700 px-3 py-2">
          <option value="Feedback">Feedback</option>
          <option value="Bug">Bug</option>
          <option value="Lizenzanfrage">Lizenzanfrage</option>
        </select>
      </div>

      <div>
        <label class="block text-sm mb-1">Song (optional)</label>
        <select name="song" id="song" class="w-full rounded-lg bg-neutral-900 border border-neutral-700 px-3 py-2">
          <option value="">— keiner —</option>
        </select>
        <p class="hint text-neutral-400 mt-1">Wird aus deiner songs.json geladen.</p>
      </div>

      <div>
        <label class="block text-sm mb-1">Betreff (optional)</label>
        <input name="subject" id="subject" class="w-full rounded-lg bg-neutral-900 border border-neutral-700 px-3 py-2" />
      </div>

      <div>
        <label class="block text-sm mb-1">Nachricht <span class="text-neutral-400">(mind. 20 Zeichen)</span></label>
        <textarea name="message" id="message" rows="6"
                  class="w-full rounded-lg bg-neutral-900 border border-neutral-700 px-3 py-2"
                  placeholder="Was ist los?"></textarea>
        <div class="flex justify-between items-center mt-1">
          <p class="hint text-neutral-400">Strg/⌘+Enter zum Senden</p>
          <p class="hint text-neutral-400"><span id="count">0</span>/4000</p>
        </div>
      </div>

      <div>
        <label class="block text-sm mb-1">E-Mail für Antwort</label>
        <input type="email" name="reply_to" id="reply_to" required
               class="w-full rounded-lg bg-neutral-900 border border-neutral-700 px-3 py-2"
               placeholder="dein.name@example.com" />
      </div>

      <div class="flex items-start gap-2">
        <input type="checkbox" id="consent" class="mt-1">
        <label for="consent" class="text-sm text-neutral-300">
          Ich stimme zu, dass meine Angaben zur Kontaktaufnahme gespeichert und per E-Mail an R.A.L.F. übermittelt werden.
        </label>
      </div>

      <div class="pt-2 flex gap-3">
        <button id="sendBtn" class="bg-orange-600 hover:bg-orange-500 text-white font-semibold rounded-full px-4 py-2">
          Senden
        </button>
        <a id="mailtoFallback" class="text-sm text-neutral-400 underline underline-offset-4" href="#">
          Oder E-Mail öffnen
        </a>
      </div>
    </form>
  </div>

  <script>
    // Erfolgsmeldung bei Redirect (?ok=1)
    (function(){
      const p=new URLSearchParams(location.search);
      const ok=p.get('ok');
      if(ok==='1'){
        const el=document.getElementById('status');
        el.className='mt-4 p-3 rounded-lg border border-green-700 bg-green-900/30 text-green-200';
        el.textContent='Danke! Deine Nachricht wurde gesendet.';
        el.classList.remove('hidden');
        // Query säubern
        history.replaceState(null,'',location.pathname);
      }
    })();

    // _next-URL setzen (zurück auf diese Seite mit ?ok=1)
    (function(){
      const here = location.origin + location.pathname + '?ok=1';
      const next = document.getElementById('nextUrl');
      if(next) next.value = here;
    })();

    // songs.json laden für Dropdown
    (async function loadSongs(){
      try{
        const res = await fetch('/songs.json');
        const data = await res.json();
        const songs = Array.isArray(data) ? data : (data.songs || []);
        const sel = document.getElementById('song');
        songs.forEach(s=>{
          const opt=document.createElement('option');
          opt.value = s.id || '';
          opt.textContent = s.title ? `${s.title} (${s.id})` : (s.id||'');
          sel.appendChild(opt);
        });
      }catch(_){}
    })();

    // Live-Counter & Validation
    const msg=document.getElementById('message');
    const cnt=document.getElementById('count');
    msg.addEventListener('input',()=>{ cnt.textContent = Math.min(4000, msg.value.length); });

    function isEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v||''); }

    // Mailto-Fallback
    (function(){
      const fb=document.getElementById('mailtoFallback');
      const to = (document.querySelector('form').action || '').split('https://formsubmit.co/')[1] || 'YOUR_EMAIL_HERE';
      fb.href = `mailto:${to}?subject=${encodeURIComponent('[R.A.L.F. Kontakt]')}`;
    })();

    // Submit-Handling (Client-Checks, dann normales POST)
    const form=document.getElementById('contactForm');
    const btn=document.getElementById('sendBtn');

    // Strg/⌘+Enter sendet
    form.addEventListener('keydown',(e)=>{
      if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); btn.click(); }
    });

    form.addEventListener('submit',(e)=>{
      // Wir lassen echtes POST laufen, aber brechen ab, wenn Checks failen
      const email = document.getElementById('reply_to').value.trim();
      const okLen = (msg.value.trim().length >= 20 && msg.value.length <= 4000);
      const okMail = isEmail(email);
      const okConsent = document.getElementById('consent').checked;

      if(!okLen || !okMail || !okConsent){
        e.preventDefault();
        let err = [];
        if(!okLen) err.push('Nachricht zu kurz (mind. 20 Zeichen).');
        if(!okMail) err.push('Bitte gültige E-Mail eingeben.');
        if(!okConsent) err.push('Bitte der Speicherung/Übermittlung zustimmen.');
        alert(err.join('\n'));
        return false;
      }
      // Optional: throttle (einfach)
      btn.disabled = true;
      btn.textContent = 'Sende…';
      setTimeout(()=>{ btn.disabled=false; btn.textContent='Senden'; }, 6000);
    });
  </script>
</body>
</html>
